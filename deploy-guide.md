# üöÄ Guia Completo de Deploy - Sistema Helpdesk IT

Este guia fornece instru√ß√µes detalhadas para fazer deploy do sistema de helpdesk em um servidor Linux para produ√ß√£o, incluindo configura√ß√£o completa do sistema de notifica√ß√µes por email.

## üìã Vis√£o Geral do Sistema

- **Frontend:** React + TypeScript + Vite
- **Backend:** Express.js + TypeScript + REST API
- **Banco de Dados:** SQLite + Drizzle ORM (100% local)
- **Notifica√ß√µes:** Sistema de email autom√°tico via SMTP
- **Autentica√ß√£o:** Sistema seguro com hash PBKDF2 + roles (t√©cnico/admin)
- **UI:** Tailwind CSS + shadcn/ui
- **Upload de Arquivos:** Multer + armazenamento local
- **Vantagem:** Sistema 100% self-contained, funciona offline ap√≥s configura√ß√£o inicial

## ‚úÖ Funcionalidades Implementadas

- ‚úÖ Sistema de abertura de chamados
- ‚úÖ Dashboard para t√©cnicos e administradores
- ‚úÖ Controle de permiss√µes por role
- ‚úÖ Upload e download de arquivos
- ‚úÖ Sistema de coment√°rios em tempo real
- ‚úÖ **Notifica√ß√µes autom√°ticas por email:**
  - ‚úâÔ∏è Email na cria√ß√£o do chamado
  - ‚úâÔ∏è Email quando t√©cnico assume o chamado
  - ‚úâÔ∏è Email em coment√°rios/atualiza√ß√µes
  - ‚úâÔ∏è Email em mudan√ßas de prioridade
  - ‚úâÔ∏è Email na resolu√ß√£o do chamado
- ‚úÖ Relat√≥rios e estat√≠sticas
- ‚úÖ Backup autom√°tico

## üñ•Ô∏è Requisitos do Sistema

### Hardware M√≠nimo
- **RAM:** 2GB (recomendado 4GB+ para melhor performance)
- **CPU:** 1 core (recomendado 2+ cores)
- **Armazenamento:** 10GB livres (recomendado 20GB+)
- **Rede:** Acesso √† internet para instala√ß√£o e envio de emails

### Software Obrigat√≥rio
- **OS:** Ubuntu 20.04+ / CentOS 8+ / Debian 11+
- **Node.js:** v18.0+ (recomendado v20+)
- **Nginx:** v1.18+ (proxy reverso)
- **PM2:** Gerenciador de processos Node.js
- **SQLite:** Inclu√≠do automaticamente

## üåê Prepara√ß√£o do Servidor

### 1. Atualizar Sistema
```bash
# Ubuntu/Debian
sudo apt update && sudo apt upgrade -y

# CentOS/RHEL
sudo yum update -y
```

### 2. Instalar Node.js 20 LTS
```bash
# Usando NodeSource Repository (recomendado)
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt-get install -y nodejs

# Verificar instala√ß√£o
node --version  # deve mostrar v20.x.x
npm --version   # deve mostrar v10.x.x
```

### 3. Instalar Ferramentas Essenciais
```bash
# Ubuntu/Debian
sudo apt install -y nginx git curl build-essential sqlite3

# CentOS/RHEL
sudo yum install -y nginx git curl gcc-c++ make sqlite
```

### 4. Instalar PM2 Globalmente
```bash
sudo npm install -g pm2

# Verificar instala√ß√£o
pm2 --version
```

### 5. Configurar Firewall
```bash
# Habilitar firewall
sudo ufw enable

# Permitir conex√µes essenciais
sudo ufw allow ssh
sudo ufw allow http
sudo ufw allow https

# Verificar status
sudo ufw status
```

## üë§ Prepara√ß√£o da Aplica√ß√£o

### 1. Criar Usu√°rio para Aplica√ß√£o
```bash
# Criar usu√°rio dedicado
sudo adduser --system --group --home /home/helpdesk helpdesk

# Criar diret√≥rio da aplica√ß√£o
sudo mkdir -p /home/helpdesk/app
sudo chown helpdesk:helpdesk /home/helpdesk/app
```

### 2. Transferir C√≥digo da Aplica√ß√£o
```bash
# M√©todo 1: Upload direto (recomendado para produ√ß√£o)
# Compacte seus arquivos localmente e use scp:
tar -czf helpdesk-app.tar.gz .
scp helpdesk-app.tar.gz usuario@servidor:/home/helpdesk/

# No servidor, descompacte:
sudo su - helpdesk
cd /home/helpdesk
tar -xzf helpdesk-app.tar.gz -C app/
cd app/

# M√©todo 2: Git clone (se o c√≥digo estiver em reposit√≥rio)
sudo su - helpdesk
cd /home/helpdesk
git clone https://github.com/seu-usuario/helpdesk-repo.git app
cd app/
```

### 3. Instalar Depend√™ncias
```bash
# Como usu√°rio helpdesk
cd /home/helpdesk/app

# Instalar depend√™ncias de produ√ß√£o
npm install --production --no-optional

# Verificar se todas as depend√™ncias foram instaladas
npm list --depth=0
```

## ‚öôÔ∏è Configura√ß√£o de Vari√°veis de Ambiente

### 1. Criar Arquivo .env
```bash
cd /home/helpdesk/app
nano .env
```

### 2. Configura√ß√£o Completa do .env
```env
# ===========================================
# CONFIGURA√á√ÉO GERAL DA APLICA√á√ÉO
# ===========================================
NODE_ENV=production
PORT=3000

# Chave de sess√£o (OBRIGAT√ìRIA - gere uma chave √∫nica)
SESSION_SECRET="SUA_CHAVE_SUPER_SEGURA_DE_32_CARACTERES_AQUI"

# ===========================================
# CONFIGURA√á√ÉO DE UPLOAD DE ARQUIVOS
# ===========================================
UPLOAD_PATH="/home/helpdesk/app/uploads"
MAX_FILE_SIZE=50MB

# ===========================================
# CONFIGURA√á√ÉO DE EMAIL SMTP
# ===========================================
# Email remetente (ser√° exibido como remetente dos emails)
EMAIL_FROM="suporte@suaempresa.com"

# Configura√ß√µes SMTP do servidor de email
SMTP_HOST="smtp.gmail.com"
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER="seu-email@gmail.com"
SMTP_PASS="sua-senha-de-app"

# ===========================================
# CONFIGURA√á√ïES ESPEC√çFICAS POR PROVEDOR
# ===========================================

# GMAIL (usando senha de app):
# SMTP_HOST=smtp.gmail.com
# SMTP_PORT=587
# SMTP_SECURE=false
# SMTP_USER=seu-email@gmail.com
# SMTP_PASS=sua-senha-de-aplicativo

# OUTLOOK/HOTMAIL:
# SMTP_HOST=smtp-mail.outlook.com
# SMTP_PORT=587
# SMTP_SECURE=false
# SMTP_USER=seu-email@outlook.com
# SMTP_PASS=sua-senha

# SERVIDOR SMTP PERSONALIZADO:
# SMTP_HOST=mail.suaempresa.com
# SMTP_PORT=587 (ou 465 para SSL)
# SMTP_SECURE=false (true para porta 465)
# SMTP_USER=suporte@suaempresa.com
# SMTP_PASS=senha-do-email

# SENDGRID:
# SMTP_HOST=smtp.sendgrid.net
# SMTP_PORT=587
# SMTP_SECURE=false
# SMTP_USER=apikey
# SMTP_PASS=sua-api-key-do-sendgrid

# ===========================================
# CONFIGURA√á√ïES OPCIONAIS
# ===========================================
# Logging level (error, warn, info, debug)
LOG_LEVEL=info

# Tempo limite para uploads (em segundos)
UPLOAD_TIMEOUT=300

# Modo de desenvolvimento/teste (deixe em false para produ√ß√£o)
DEBUG_MODE=false
```

### 3. Configurar Permiss√µes do .env
```bash
# Proteger arquivo de configura√ß√£o
chmod 600 /home/helpdesk/app/.env
chown helpdesk:helpdesk /home/helpdesk/app/.env
```

## üìß Configura√ß√£o Espec√≠fica de Email

### Gmail (Recomendado para empresas pequenas)

1. **Habilitar autentica√ß√£o de 2 fatores** na sua conta Gmail
2. **Gerar senha de aplicativo:**
   - Acesse: https://myaccount.google.com/security
   - Clique em "Senhas de app"
   - Selecione "Aplicativo personalizado"
   - Digite "Helpdesk Sistema" e gere a senha
   - Use esta senha no `SMTP_PASS`

```env
EMAIL_FROM="suporte@suaempresa.com"
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=seu-email@gmail.com
SMTP_PASS=senha-de-aplicativo-gerada
```

### Outlook/Hotmail

```env
EMAIL_FROM="suporte@suaempresa.com"
SMTP_HOST=smtp-mail.outlook.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=seu-email@outlook.com
SMTP_PASS=sua-senha-normal
```

### Servidor SMTP Pr√≥prio da Empresa

```env
EMAIL_FROM="suporte@suaempresa.com"
SMTP_HOST=mail.suaempresa.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=suporte@suaempresa.com
SMTP_PASS=senha-do-email-corporativo
```

### SendGrid (Para alto volume)

1. Criar conta no SendGrid
2. Gerar API Key
3. Configurar:

```env
EMAIL_FROM="suporte@suaempresa.com"
SMTP_HOST=smtp.sendgrid.net
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=apikey
SMTP_PASS=SG.sua-api-key-do-sendgrid
```

## üèóÔ∏è Build e Prepara√ß√£o da Aplica√ß√£o

### 1. Criar Diret√≥rios Necess√°rios
```bash
cd /home/helpdesk/app

# Criar diret√≥rios essenciais
mkdir -p uploads
mkdir -p logs
mkdir -p backups

# Definir permiss√µes corretas
chmod 755 uploads
chmod 755 logs
chmod 755 backups
```

### 2. Gerar SESSION_SECRET Seguro
```bash
# Gerar chave aleat√≥ria de 32 caracteres
openssl rand -base64 32

# Editar .env e substituir SESSION_SECRET pela chave gerada
nano .env
```

### 3. Build da Aplica√ß√£o
```bash
cd /home/helpdesk/app

# Instalar depend√™ncias de desenvolvimento para build
npm install

# Fazer build do frontend e backend
npm run build

# Verificar se build foi criado
ls -la dist/

# Remover depend√™ncias de desenvolvimento (economizar espa√ßo)
npm prune --production
```

## üîß Configura√ß√£o do PM2

### 1. Verificar Configura√ß√£o PM2
```bash
cd /home/helpdesk/app
cat ecosystem.config.js
```

O arquivo deve estar assim:
```javascript
module.exports = {
  apps: [{
    name: 'helpdesk',
    script: './dist/index.js',
    cwd: '/home/helpdesk/app',
    instances: 1, // Para SQLite use sempre 1
    exec_mode: 'fork',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    // Logs
    error_file: './logs/err.log',
    out_file: './logs/out.log',
    log_file: './logs/combined.log',
    time: true,
    
    // Performance
    max_memory_restart: '1G',
    restart_delay: 4000,
    max_restarts: 10,
    min_uptime: '10s',
    
    // Health check
    kill_timeout: 5000,
    wait_ready: true,
    listen_timeout: 10000,
    
    // Auto restart em caso de crash
    autorestart: true,
    watch: false
  }]
}
```

### 2. Iniciar Aplica√ß√£o com PM2
```bash
cd /home/helpdesk/app

# Iniciar aplica√ß√£o
pm2 start ecosystem.config.js

# Verificar status
pm2 status

# Salvar configura√ß√£o para reinicializa√ß√£o autom√°tica
pm2 save

# Configurar inicializa√ß√£o autom√°tica na inicializa√ß√£o do sistema
pm2 startup systemd
# IMPORTANTE: Execute o comando que o PM2 mostrar na tela

# Verificar logs
pm2 logs helpdesk --lines 20
```

## üóÑÔ∏è Inicializa√ß√£o do Banco de Dados

### 1. Verificar Cria√ß√£o Autom√°tica do Banco
```bash
cd /home/helpdesk/app

# O banco SQLite ser√° criado automaticamente
# Verificar se foi criado com sucesso
ls -la helpdesk.db

# Se n√£o existir, verificar logs para diagn√≥stico
pm2 logs helpdesk
```

### 2. Criar Usu√°rios Iniciais

**Importante:** Aguarde alguns segundos ap√≥s iniciar a aplica√ß√£o antes de criar usu√°rios.

```bash
# Testar se aplica√ß√£o est√° respondendo
curl -I http://localhost:3000/

# Criar usu√°rio administrador
curl -X POST http://localhost:3000/api/users \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "Admin123!@#",
    "name": "Administrador do Sistema",
    "email": "admin@suaempresa.com",
    "role": "admin"
  }'

# Criar usu√°rio t√©cnico
curl -X POST http://localhost:3000/api/users \
  -H "Content-Type: application/json" \
  -d '{
    "username": "tecnico1",
    "password": "Tech123!@#",
    "name": "T√©cnico de TI",
    "email": "tecnico@suaempresa.com", 
    "role": "technician"
  }'

# Verificar se usu√°rios foram criados
sqlite3 helpdesk.db "SELECT username, name, role FROM users;"
```

## üåê Configura√ß√£o do Nginx

### 1. Criar Configura√ß√£o do Site
```bash
sudo nano /etc/nginx/sites-available/helpdesk
```

### 2. Conte√∫do da Configura√ß√£o Nginx
```nginx
# Configura√ß√£o do Nginx para Sistema Helpdesk
server {
    listen 80;
    server_name seu-dominio.com www.seu-dominio.com;

    # Tamanho m√°ximo de upload (importante para anexos)
    client_max_body_size 50M;
    client_body_timeout 60s;
    client_header_timeout 60s;

    # Logs espec√≠ficos do sistema
    access_log /var/log/nginx/helpdesk.access.log;
    error_log /var/log/nginx/helpdesk.error.log;

    # Configura√ß√µes de seguran√ßa
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Proxy principal para aplica√ß√£o Node.js
    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # Timeouts aumentados para uploads grandes
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
        proxy_send_timeout 300s;
    }

    # Servir arquivos de upload diretamente pelo Nginx (melhor performance)
    location /uploads/ {
        alias /home/helpdesk/app/uploads/;
        expires 30d;
        add_header Cache-Control "public, immutable";
        add_header Access-Control-Allow-Origin "*";
        
        # Seguran√ßa: evitar execu√ß√£o de scripts
        location ~* \.(php|jsp|asp|sh|cgi)$ {
            deny all;
        }
    }

    # Cache para assets est√°ticos
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header Access-Control-Allow-Origin "*";
    }

    # Compress√£o Gzip
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied expired no-cache no-store private must-revalidate auth;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/javascript
        application/xml+rss
        application/json;

    # Rate limiting b√°sico
    limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
    location /api/ {
        limit_req zone=api burst=20 nodelay;
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### 3. Habilitar Site e Testar
```bash
# Habilitar site
sudo ln -s /etc/nginx/sites-available/helpdesk /etc/nginx/sites-enabled/

# Remover site padr√£o se necess√°rio
sudo rm -f /etc/nginx/sites-enabled/default

# Testar configura√ß√£o
sudo nginx -t

# Se teste passou, reiniciar Nginx
sudo systemctl restart nginx

# Verificar status
sudo systemctl status nginx
```

## üîí Configura√ß√£o SSL com Let's Encrypt

### 1. Instalar Certbot
```bash
# Ubuntu/Debian
sudo apt install certbot python3-certbot-nginx -y

# CentOS/RHEL
sudo yum install certbot python3-certbot-nginx -y
```

### 2. Obter Certificado SSL
```bash
# Substituir seu-dominio.com pelo seu dom√≠nio real
sudo certbot --nginx -d seu-dominio.com -d www.seu-dominio.com

# Seguir as instru√ß√µes na tela
# Escolher op√ß√£o para redirecionar HTTP para HTTPS automaticamente
```

### 3. Testar Renova√ß√£o Autom√°tica
```bash
# Testar renova√ß√£o
sudo certbot renew --dry-run

# Verificar se cron job foi criado
sudo crontab -l | grep certbot
```

## üß™ Testes Completos do Sistema

### 1. Teste de Funcionalidade B√°sica
```bash
# Testar se aplica√ß√£o responde
curl -I http://localhost:3000/
# Deve retornar: HTTP/1.1 200 OK

# Testar endpoint de API
curl http://localhost:3000/api/stats
# Deve retornar JSON com estat√≠sticas
```

### 2. Teste de Autentica√ß√£o
```bash
# Testar login do administrador
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"Admin123!@#"}'

# Deve retornar: {"id":"...","username":"admin","role":"admin"}
```

### 3. Teste de Sistema de Email
```bash
# Criar um ticket de teste para verificar envio de email
curl -X POST http://localhost:3000/api/tickets \
  -H "Content-Type: application/json" \
  -d '{
    "title": "Teste do sistema de email",
    "description": "Testando se emails s√£o enviados corretamente",
    "sector": "TI",
    "problemType": "teste",
    "priority": "medium",
    "requesterName": "Teste User",
    "userEmail": "seuemail@test.com"
  }'

# Verificar nos logs se email foi enviado
pm2 logs helpdesk | grep -i email

# Verificar se email chegou na caixa de entrada do seuemail@test.com
```

### 4. Teste de Upload de Arquivos
```bash
# Criar arquivo de teste
echo "Teste de upload" > /tmp/teste.txt

# Testar upload
curl -X POST http://localhost:3000/api/upload/test \
  -F "file=@/tmp/teste.txt"

# Verificar se arquivo foi salvo
ls -la /home/helpdesk/app/uploads/
```

### 5. Teste de Performance
```bash
# Instalar Apache Bench para teste de carga
sudo apt install apache2-utils -y

# Teste b√°sico de carga
ab -n 100 -c 10 http://localhost:3000/

# Monitorar recursos durante teste
htop
```

## üìä Monitoramento e Logs

### 1. Monitoramento da Aplica√ß√£o
```bash
# Status detalhado da aplica√ß√£o
pm2 status

# Logs em tempo real
pm2 logs helpdesk

# Monitoramento de recursos
pm2 monit

# Estat√≠sticas de reinicializa√ß√µes
pm2 show helpdesk
```

### 2. Monitoramento do Sistema
```bash
# Uso de CPU e mem√≥ria
htop

# Uso do disco
df -h
du -sh /home/helpdesk/app/

# Conex√µes de rede
netstat -tlnp | grep :3000

# Verificar portas abertas
sudo ufw status
```

### 3. Logs do Nginx
```bash
# Logs de acesso em tempo real
sudo tail -f /var/log/nginx/helpdesk.access.log

# Logs de erro
sudo tail -f /var/log/nginx/helpdesk.error.log

# Analisar logs de erro mais recentes
sudo tail -50 /var/log/nginx/helpdesk.error.log
```

### 4. Monitoramento do Email
```bash
# Verificar configura√ß√£o SMTP nos logs
pm2 logs helpdesk | grep -i smtp

# Verificar emails enviados
pm2 logs helpdesk | grep -i "email enviado"

# Verificar erros de email
pm2 logs helpdesk | grep -i "erro.*email"
```

## üíæ Sistema de Backup Autom√°tico

### 1. Script de Backup Completo
```bash
# Criar script de backup
sudo nano /home/helpdesk/backup-helpdesk.sh
```

Conte√∫do do script:
```bash
#!/bin/bash
# Script de backup completo do sistema Helpdesk
# Criado para backup autom√°tico di√°rio

# Configura√ß√µes
BACKUP_DIR="/home/helpdesk/backups"
APP_DIR="/home/helpdesk/app"
DATE=$(date +%Y%m%d_%H%M%S)
RETENTION_DAYS=7

# Criar diret√≥rio de backup se n√£o existir
mkdir -p $BACKUP_DIR

echo "=== BACKUP HELPDESK INICIADO ==="
echo "Data/Hora: $(date)"
echo "Backup ID: $DATE"

# 1. Parar aplica√ß√£o para backup consistente
echo "Parando aplica√ß√£o..."
pm2 stop helpdesk

# 2. Backup do banco SQLite
echo "Fazendo backup do banco de dados..."
if [ -f "$APP_DIR/helpdesk.db" ]; then
    cp "$APP_DIR/helpdesk.db" "$BACKUP_DIR/helpdesk_${DATE}.db"
    echo "‚úÖ Banco de dados: helpdesk_${DATE}.db"
else
    echo "‚ùå Erro: Banco de dados n√£o encontrado!"
fi

# 3. Backup dos arquivos de upload
echo "Fazendo backup dos uploads..."
if [ -d "$APP_DIR/uploads" ] && [ "$(ls -A $APP_DIR/uploads)" ]; then
    tar -czf "$BACKUP_DIR/uploads_${DATE}.tar.gz" -C "$APP_DIR" uploads/
    echo "‚úÖ Uploads: uploads_${DATE}.tar.gz"
else
    echo "‚ö†Ô∏è Diret√≥rio de uploads vazio ou n√£o encontrado"
fi

# 4. Backup da configura√ß√£o
echo "Fazendo backup da configura√ß√£o..."
if [ -f "$APP_DIR/.env" ]; then
    cp "$APP_DIR/.env" "$BACKUP_DIR/env_${DATE}.backup"
    echo "‚úÖ Configura√ß√£o: env_${DATE}.backup"
fi

# 5. Backup dos logs
echo "Fazendo backup dos logs..."
if [ -d "$APP_DIR/logs" ] && [ "$(ls -A $APP_DIR/logs)" ]; then
    tar -czf "$BACKUP_DIR/logs_${DATE}.tar.gz" -C "$APP_DIR" logs/
    echo "‚úÖ Logs: logs_${DATE}.tar.gz"
fi

# 6. Reiniciar aplica√ß√£o
echo "Reiniciando aplica√ß√£o..."
pm2 start helpdesk

# 7. Limpeza de backups antigos
echo "Limpando backups antigos (>$RETENTION_DAYS dias)..."
find $BACKUP_DIR -name "helpdesk_*.db" -mtime +$RETENTION_DAYS -delete
find $BACKUP_DIR -name "uploads_*.tar.gz" -mtime +$RETENTION_DAYS -delete
find $BACKUP_DIR -name "env_*.backup" -mtime +$RETENTION_DAYS -delete
find $BACKUP_DIR -name "logs_*.tar.gz" -mtime +$RETENTION_DAYS -delete

# 8. Relat√≥rio final
echo ""
echo "=== BACKUP CONCLU√çDO ==="
echo "Arquivos criados:"
ls -lh $BACKUP_DIR/*${DATE}*
echo ""
echo "Espa√ßo usado pelos backups:"
du -sh $BACKUP_DIR
echo ""
echo "Backups dispon√≠veis:"
ls -la $BACKUP_DIR | grep $(date +%Y%m)
```

### 2. Configurar Execu√ß√£o Autom√°tica
```bash
# Tornar script execut√°vel
chmod +x /home/helpdesk/backup-helpdesk.sh

# Testar script
sudo /home/helpdesk/backup-helpdesk.sh

# Configurar cron para backup di√°rio √†s 2:30 AM
sudo crontab -e

# Adicionar linha:
30 2 * * * /home/helpdesk/backup-helpdesk.sh >> /var/log/helpdesk-backup.log 2>&1

# Verificar se cron foi configurado
sudo crontab -l
```

### 3. Script de Restaura√ß√£o
```bash
# Criar script de restaura√ß√£o
sudo nano /home/helpdesk/restore-helpdesk.sh
```

Conte√∫do:
```bash
#!/bin/bash
# Script de restaura√ß√£o do sistema Helpdesk

if [ "$#" -ne 1 ]; then
    echo "Uso: $0 YYYYMMDD_HHMMSS"
    echo "Exemplo: $0 20241010_023000"
    exit 1
fi

BACKUP_ID=$1
BACKUP_DIR="/home/helpdesk/backups"
APP_DIR="/home/helpdesk/app"

echo "=== RESTAURA√á√ÉO HELPDESK ==="
echo "Backup ID: $BACKUP_ID"

# Verificar se backups existem
if [ ! -f "$BACKUP_DIR/helpdesk_${BACKUP_ID}.db" ]; then
    echo "‚ùå Erro: Backup do banco n√£o encontrado!"
    exit 1
fi

# Parar aplica√ß√£o
echo "Parando aplica√ß√£o..."
pm2 stop helpdesk

# Backup atual antes de restaurar
echo "Fazendo backup de seguran√ßa do estado atual..."
cp "$APP_DIR/helpdesk.db" "$APP_DIR/helpdesk.db.pre-restore"

# Restaurar banco
echo "Restaurando banco de dados..."
cp "$BACKUP_DIR/helpdesk_${BACKUP_ID}.db" "$APP_DIR/helpdesk.db"

# Restaurar uploads se existir
if [ -f "$BACKUP_DIR/uploads_${BACKUP_ID}.tar.gz" ]; then
    echo "Restaurando uploads..."
    rm -rf "$APP_DIR/uploads"
    tar -xzf "$BACKUP_DIR/uploads_${BACKUP_ID}.tar.gz" -C "$APP_DIR/"
fi

# Restaurar configura√ß√£o se solicitado
read -p "Restaurar configura√ß√£o .env? (y/N): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    if [ -f "$BACKUP_DIR/env_${BACKUP_ID}.backup" ]; then
        cp "$BACKUP_DIR/env_${BACKUP_ID}.backup" "$APP_DIR/.env"
        echo "‚úÖ Configura√ß√£o restaurada"
    fi
fi

# Ajustar permiss√µes
chown -R helpdesk:helpdesk "$APP_DIR"
chmod 600 "$APP_DIR/helpdesk.db"
chmod 600 "$APP_DIR/.env"

# Reiniciar aplica√ß√£o
echo "Reiniciando aplica√ß√£o..."
pm2 start helpdesk

echo "‚úÖ Restaura√ß√£o conclu√≠da!"
```

```bash
# Tornar execut√°vel
chmod +x /home/helpdesk/restore-helpdesk.sh
```

## üîß Troubleshooting Comum

### 1. Problemas de Email

#### Email n√£o √© enviado
```bash
# Verificar configura√ß√£o nos logs
pm2 logs helpdesk | grep -i smtp

# Testar conex√£o SMTP manualmente
telnet smtp.gmail.com 587

# Verificar vari√°veis de ambiente
cd /home/helpdesk/app
grep SMTP .env

# Testar configura√ß√£o de email via Node.js
node -e "
const nodemailer = require('nodemailer');
const transporter = nodemailer.createTransporter({
  host: 'smtp.gmail.com',
  port: 587,
  secure: false,
  auth: {
    user: 'seu-email@gmail.com',
    pass: 'sua-senha-de-app'
  }
});
transporter.verify().then(console.log).catch(console.error);
"
```

#### Erro "Authentication failed"
```bash
# Para Gmail, verificar se:
# 1. Autentica√ß√£o de 2 fatores est√° habilitada
# 2. Senha de aplicativo foi gerada corretamente
# 3. Est√° usando a senha de aplicativo, n√£o a senha normal

# Para outros provedores, verificar:
# 1. Usu√°rio e senha est√£o corretos
# 2. SMTP_HOST e SMTP_PORT est√£o corretos
# 3. SMTP_SECURE est√° configurado corretamente
```

#### Emails v√£o para spam
```bash
# Configurar SPF record no DNS:
# "v=spf1 include:_spf.google.com ~all" (para Gmail)

# Configurar DKIM se poss√≠vel
# Usar dom√≠nio corporativo no EMAIL_FROM
```

### 2. Problemas de Performance

#### Alta utiliza√ß√£o de mem√≥ria
```bash
# Verificar uso de mem√≥ria
pm2 monit

# Ajustar limite de mem√≥ria no ecosystem.config.js
nano ecosystem.config.js
# Alterar: max_memory_restart: '512M'

# Reiniciar aplica√ß√£o
pm2 restart helpdesk
```

#### Aplica√ß√£o lenta
```bash
# Verificar logs de erro
pm2 logs helpdesk --err

# Otimizar banco SQLite
sqlite3 /home/helpdesk/app/helpdesk.db "VACUUM;"

# Verificar tamanho do banco
ls -lh /home/helpdesk/app/helpdesk.db

# Verificar espa√ßo em disco
df -h /home/helpdesk/
```

### 3. Problemas de Conectividade

#### Nginx n√£o conecta na aplica√ß√£o
```bash
# Verificar se aplica√ß√£o est√° rodando
pm2 status helpdesk

# Verificar se porta 3000 est√° ouvindo
netstat -tlnp | grep 3000

# Testar conex√£o local
curl http://localhost:3000/

# Verificar logs do Nginx
sudo tail -f /var/log/nginx/helpdesk.error.log
```

#### Erro 502 Bad Gateway
```bash
# Verificar se aplica√ß√£o est√° rodando
pm2 restart helpdesk

# Verificar logs da aplica√ß√£o
pm2 logs helpdesk

# Verificar configura√ß√£o do Nginx
sudo nginx -t

# Reiniciar Nginx
sudo systemctl restart nginx
```

### 4. Problemas de Upload

#### Upload de arquivos falha
```bash
# Verificar permiss√µes do diret√≥rio
ls -la /home/helpdesk/app/uploads/
chmod 755 /home/helpdesk/app/uploads/

# Verificar espa√ßo em disco
df -h /home/helpdesk/

# Verificar logs para erros de upload
pm2 logs helpdesk | grep -i upload

# Testar upload pequeno
curl -X POST http://localhost:3000/api/upload/test \
  -F "file=@/etc/passwd"
```

#### Arquivo muito grande
```bash
# Verificar configura√ß√£o no .env
grep MAX_FILE_SIZE /home/helpdesk/app/.env

# Verificar configura√ß√£o do Nginx
sudo grep client_max_body_size /etc/nginx/sites-available/helpdesk

# Ajustar ambos se necess√°rio e reiniciar servi√ßos
```

## üìã Checklist Final de Deploy

Antes de considerar o deploy conclu√≠do, verifique:

### ‚úÖ Infraestrutura
- [ ] Node.js 20+ instalado e funcionando
- [ ] PM2 instalado globalmente
- [ ] Nginx instalado e configurado
- [ ] Firewall configurado (SSH, HTTP, HTTPS)
- [ ] SSL configurado com Let's Encrypt
- [ ] Usu√°rio helpdesk criado com permiss√µes adequadas

### ‚úÖ Aplica√ß√£o
- [ ] C√≥digo da aplica√ß√£o transferido
- [ ] Depend√™ncias instaladas (`npm install --production`)
- [ ] Build realizado com sucesso (`npm run build`)
- [ ] Arquivo .env configurado com todas as vari√°veis
- [ ] SESSION_SECRET √∫nico gerado
- [ ] Diret√≥rios uploads, logs, backups criados
- [ ] Permiss√µes de arquivo adequadas

### ‚úÖ Banco de Dados
- [ ] Banco SQLite criado automaticamente
- [ ] Usu√°rio admin criado e testado
- [ ] Usu√°rio t√©cnico criado e testado
- [ ] Login admin funcionando
- [ ] Login t√©cnico funcionando

### ‚úÖ Sistema de Email
- [ ] Vari√°veis SMTP configuradas no .env
- [ ] Configura√ß√£o de email testada
- [ ] Ticket de teste criado para verificar email
- [ ] Email de cria√ß√£o recebido
- [ ] Email de atribui√ß√£o recebido
- [ ] Sem erros de SMTP nos logs

### ‚úÖ Funcionalidades
- [ ] Abertura de chamados funcionando
- [ ] Dashboard admin acess√≠vel
- [ ] Dashboard t√©cnico acess√≠vel
- [ ] Upload de arquivos funcionando
- [ ] Download de arquivos funcionando
- [ ] Sistema de coment√°rios funcionando
- [ ] Relat√≥rios carregando dados
- [ ] Notifica√ß√µes por email funcionando

### ‚úÖ Monitoramento
- [ ] PM2 mostrando status "online"
- [ ] Logs sendo gerados sem erros
- [ ] Nginx proxy funcionando
- [ ] SSL redirecionando HTTPS corretamente
- [ ] Backup autom√°tico configurado
- [ ] Scripts de manuten√ß√£o criados

### ‚úÖ Seguran√ßa
- [ ] Todas as senhas padr√£o alteradas
- [ ] SESSION_SECRET √∫nico configurado
- [ ] Arquivo .env protegido (chmod 600)
- [ ] Banco SQLite protegido (chmod 600)
- [ ] Firewall UFW habilitado
- [ ] Headers de seguran√ßa configurados no Nginx

### ‚úÖ Performance
- [ ] Compress√£o Gzip habilitada
- [ ] Cache de arquivos est√°ticos configurado
- [ ] Rate limiting configurado
- [ ] Limites de mem√≥ria configurados no PM2
- [ ] Teste de carga b√°sico realizado

## üéØ URLs de Acesso Final

Ap√≥s deploy completo, o sistema estar√° dispon√≠vel em:

- **URL Principal:** `https://seu-dominio.com`
- **Dashboard Admin:** `https://seu-dominio.com/admin`
- **Dashboard T√©cnico:** `https://seu-dominio.com/technician`
- **API Endpoints:** `https://seu-dominio.com/api/*`

### Credenciais Padr√£o (ALTERE IMEDIATAMENTE):
- **Admin:** 
  - Usu√°rio: `admin`
  - Senha: `Admin123!@#`
- **T√©cnico:**
  - Usu√°rio: `tecnico1` 
  - Senha: `Tech123!@#`

## üìû Suporte e Manuten√ß√£o

### Comandos √öteis para Manuten√ß√£o

```bash
# Status geral do sistema
pm2 status && sudo systemctl status nginx

# Reiniciar tudo
pm2 restart helpdesk && sudo systemctl restart nginx

# Ver logs em tempo real
pm2 logs helpdesk --lines 50

# Fazer backup manual
sudo /home/helpdesk/backup-helpdesk.sh

# Verificar uso de recursos
htop && df -h

# Verificar conectividade
curl -I https://seu-dominio.com
```

### Atualiza√ß√µes do Sistema

```bash
# Para atualizar a aplica√ß√£o:
cd /home/helpdesk/app
pm2 stop helpdesk
# Substituir arquivos da aplica√ß√£o
npm install --production
npm run build
pm2 start helpdesk
```

---

**‚ú® Sistema Helpdesk IT com Notifica√ß√µes por Email**  
*Deploy Guide Completo - Vers√£o 4.0*  
*Atualizado: Setembro 2025*

*Agora com sistema completo de notifica√ß√µes autom√°ticas por email e configura√ß√£o detalhada para diferentes provedores SMTP!*